// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_BOUNCER_CONNECTION_URI")
  directUrl = env("DATABASE_CONNECTION_URI")
}

enum InstanceConnectionStatus {
  open
  close
  connecting
}

enum DeviceMessage {
  ios
  android
  web
  unknown
  desktop
}

enum SessionStatus {
  opened
  closed
  paused
}

enum TriggerType {
  all
  keyword
  none
  advanced
}

enum TriggerOperator {
  contains
  equals
  startsWith
  endsWith
  regex
}

enum CompanyRole {
  owner
  admin
  member
}

model Instance {
  id                      String                   @id @default(cuid())
  name                    String                   @unique @db.VarChar(255)
  connectionStatus        InstanceConnectionStatus @default(open)
  ownerJid                String?                  @db.VarChar(100)
  profileName             String?                  @db.VarChar(100)
  profilePicUrl           String?                  @db.VarChar(500)
  integration             String?                  @db.VarChar(100)
  number                  String?                  @db.VarChar(100)
  businessId              String?                  @db.VarChar(100)
  token                   String?                  @db.VarChar(255)
  clientName              String?                  @db.VarChar(100)
  disconnectionReasonCode Int?                     @db.Integer
  disconnectionObject     Json?                    @db.JsonB
  disconnectionAt         DateTime?                @db.Timestamp
  createdAt               DateTime?                @default(now()) @db.Timestamp
  updatedAt               DateTime?                @updatedAt @db.Timestamp
  Chat                    Chat[]
  Contact                 Contact[]
  Message                 Message[]
  Webhook                 Webhook?
  Label                   Label[]
  Proxy                   Proxy?
  Setting                 Setting?
  Rabbitmq                Rabbitmq?
  Nats                    Nats?
  Sqs                     Sqs?
  Kafka                   Kafka?
  Websocket               Websocket?
  Session                 Session?
  MessageUpdate           MessageUpdate[]
  Media                   Media[]
  Credentials             Credentials[]
  Template                Template[]
  IntegrationSession      IntegrationSession[]
  Pusher                  Pusher?
  Agno                    Agno[]
  AgnoSetting             AgnoSetting?
  Funnel                  Funnel[]

  Company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  companyId String?  @db.VarChar(100)

  @@index([companyId])
}

model User {
  id           String          @id @default(cuid())
  email        String          @unique @db.VarChar(255)
  passwordHash String          @db.VarChar(255)
  name         String?         @db.VarChar(100)
  createdAt    DateTime?       @default(now()) @db.Timestamp
  updatedAt    DateTime?       @updatedAt @db.Timestamp
  memberships  CompanyMember[]
}

model Company {
  id         String          @id @default(cuid())
  name       String          @db.VarChar(150)
  agnoPorts  Json?
  createdAt  DateTime?       @default(now()) @db.Timestamp
  updatedAt  DateTime?       @updatedAt @db.Timestamp
  members    CompanyMember[]
  apiKeys    ApiKey[]
  credentials Credentials[]
  instances  Instance[]
  Funnel     Funnel[]

  @@unique([name])
}

model CompanyMember {
  id        String      @id @default(cuid())
  role      CompanyRole @default(member)
  createdAt DateTime?   @default(now()) @db.Timestamp
  User      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  Company   Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  @@unique([userId, companyId])
  @@index([companyId])
  @@index([userId])
}

model ApiKey {
  id         String    @id @default(cuid())
  name       String?   @db.VarChar(100)
  keyHash    String    @unique @db.VarChar(128)
  prefix     String    @db.VarChar(16)
  isPrimary  Boolean   @default(false)
  encryptedKey String?  @db.VarChar(512)
  keyIv        String?  @db.VarChar(64)
  createdAt  DateTime? @default(now()) @db.Timestamp
  lastUsedAt DateTime? @db.Timestamp
  revokedAt  DateTime? @db.Timestamp
  Company    Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId  String

  @@index([companyId])
}

model Session {
  id        String   @id @default(cuid())
  sessionId String   @unique
  creds     String?  @db.Text
  createdAt DateTime @default(now()) @db.Timestamp
  Instance  Instance @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Chat {
  id             String    @id @default(cuid())
  remoteJid      String    @db.VarChar(100)
  name           String?   @db.VarChar(100)
  labels         Json?     @db.JsonB
  createdAt      DateTime? @default(now()) @db.Timestamp
  updatedAt      DateTime? @updatedAt @db.Timestamp
  Instance       Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId     String
  unreadMessages Int       @default(0)

  @@index([instanceId])
  @@index([remoteJid])
}

model Contact {
  id            String    @id @default(cuid())
  remoteJid     String    @db.VarChar(100)
  pushName      String?   @db.VarChar(100)
  profilePicUrl String?   @db.VarChar(500)
  createdAt     DateTime? @default(now()) @db.Timestamp
  updatedAt     DateTime? @updatedAt @db.Timestamp
  Instance      Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId    String

  @@unique([remoteJid, instanceId])
  @@index([remoteJid])
  @@index([instanceId])
}

model Message {
  id                           String          @id @default(cuid())
  key                          Json            @db.JsonB
  pushName                     String?         @db.VarChar(100)
  participant                  String?         @db.VarChar(100)
  messageType                  String          @db.VarChar(100)
  message                      Json            @db.JsonB
  contextInfo                  Json?           @db.JsonB
  source                       DeviceMessage
  author                       String?         @db.VarChar(50)
  messageTimestamp             Int             @db.Integer
  Instance                     Instance        @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId                   String
  MessageUpdate                MessageUpdate[]
  Media                        Media?
  webhookUrl                   String?         @db.VarChar(500)
  status                       String?         @db.VarChar(30)

  sessionId String?
  session   IntegrationSession? @relation(fields: [sessionId], references: [id])

  @@index([instanceId])
}

model MessageUpdate {
  id          String    @id @default(cuid())
  keyId       String    @db.VarChar(100)
  remoteJid   String    @db.VarChar(100)
  fromMe      Boolean   @db.Boolean
  participant String?   @db.VarChar(100)
  pollUpdates Json?     @db.JsonB
  status      String    @db.VarChar(30)
  Message     Message?  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId   String?
  Instance    Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId  String

  @@index([instanceId])
  @@index([messageId])
}

model Webhook {
  id              String    @id @default(cuid())
  url             String    @db.VarChar(500)
  headers         Json?     @db.JsonB
  enabled         Boolean?  @default(true) @db.Boolean
  events          Json?     @db.JsonB
  webhookByEvents Boolean?  @default(false) @db.Boolean
  webhookBase64   Boolean?  @default(false) @db.Boolean
  createdAt       DateTime? @default(now()) @db.Timestamp
  updatedAt       DateTime  @updatedAt @db.Timestamp
  Instance        Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId      String    @unique

  @@index([instanceId])
}

model Label {
  id           String    @id @default(cuid())
  labelId      String?   @db.VarChar(100)
  name         String    @db.VarChar(100)
  color        String    @db.VarChar(100)
  predefinedId String?   @db.VarChar(100)
  createdAt    DateTime? @default(now()) @db.Timestamp
  updatedAt    DateTime  @updatedAt @db.Timestamp
  Instance     Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId   String

  @@unique([labelId, instanceId])
}

model Proxy {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false) @db.Boolean
  host       String    @db.VarChar(100)
  port       String    @db.VarChar(100)
  protocol   String    @db.VarChar(100)
  username   String    @db.VarChar(100)
  password   String    @db.VarChar(100)
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Setting {
  id              String    @id @default(cuid())
  rejectCall      Boolean   @default(false) @db.Boolean
  msgCall         String?   @db.VarChar(100)
  groupsIgnore    Boolean   @default(false) @db.Boolean
  alwaysOnline    Boolean   @default(false) @db.Boolean
  readMessages    Boolean   @default(false) @db.Boolean
  readStatus      Boolean   @default(false) @db.Boolean
  syncFullHistory Boolean   @default(false) @db.Boolean
  mediaRecognition Boolean  @default(false) @db.Boolean
  wavoipToken     String?   @db.VarChar(100)
  createdAt       DateTime? @default(now()) @db.Timestamp
  updatedAt       DateTime  @updatedAt @db.Timestamp
  Instance        Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId      String    @unique

  @@index([instanceId])
}

model Rabbitmq {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false) @db.Boolean
  events     Json      @db.JsonB
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Nats {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false) @db.Boolean
  events     Json      @db.JsonB
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Sqs {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false) @db.Boolean
  events     Json      @db.JsonB
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Kafka {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false) @db.Boolean
  events     Json      @db.JsonB
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Websocket {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false) @db.Boolean
  events     Json      @db.JsonB
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Pusher {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false) @db.Boolean
  appId      String    @db.VarChar(100)
  key        String    @db.VarChar(100)
  secret     String    @db.VarChar(100)
  cluster    String    @db.VarChar(100)
  useTLS     Boolean   @default(false) @db.Boolean
  events     Json      @db.JsonB
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Media {
  id         String    @id @default(cuid())
  fileName   String    @db.VarChar(500)
  type       String    @db.VarChar(100)
  mimetype   String    @db.VarChar(100)
  createdAt  DateTime? @default(now()) @db.Date
  Message    Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId  String    @unique
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String
}

model Credentials {
  id         String    @id @default(cuid())
  name       String?   @unique @db.VarChar(255)
  apiKey     String?   @unique @db.VarChar(255)
  provider   String    @db.VarChar(100)
  url        String?   @db.VarChar(500)
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance? @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String?
  Company    Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId  String?
  @@index([companyId])
}

model IntegrationSession {
  id         String        @id @default(cuid())
  sessionId  String        @db.VarChar(255)
  remoteJid  String        @db.VarChar(100)
  pushName   String?
  status     SessionStatus
  awaitUser  Boolean       @default(false) @db.Boolean
  context    Json?
  type       String?       @db.VarChar(100)
  createdAt  DateTime?     @default(now()) @db.Timestamp
  updatedAt  DateTime      @updatedAt @db.Timestamp
  Message    Message[]
  Instance   Instance      @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String
  parameters Json?         @db.JsonB

  botId         String?
  funnelId      String?  @db.VarChar(100)
  funnelStage   Int?     @db.Integer
  followUpStage Int?     @db.Integer
  funnelEnable  Boolean  @default(false) @db.Boolean
  followUpEnable Boolean @default(false) @db.Boolean
}

model Template {
  id         String    @id @default(cuid())
  templateId String    @unique @db.VarChar(255)
  name       String    @unique @db.VarChar(255)
  template   Json      @db.JsonB
  webhookUrl String?   @db.VarChar(500)
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String
}

model Agno {
  id              String           @id @default(cuid())
  enabled         Boolean          @default(true) @db.Boolean
  description     String?          @db.VarChar(255)
  prompt          String?          @db.Text
  agentId         String?          @db.VarChar(255)
  agentConfig     Json?            @db.JsonB
  providerModel   String?          @db.VarChar(255)
  webhookUrl      String?          @db.VarChar(500)
  agnoPort        Int?             @db.Integer
  funnelId        String?          @db.VarChar(100)
  expire          Int?             @default(0) @db.Integer
  keywordFinish   String?          @db.VarChar(100)
  delayMessage    Int?             @db.Integer
  unknownMessage  String?          @db.VarChar(100)
  listeningFromMe Boolean?         @default(false) @db.Boolean
  stopBotFromMe   Boolean?         @default(false) @db.Boolean
  keepOpen        Boolean?         @default(false) @db.Boolean
  debounceTime    Int?             @db.Integer
  ignoreJids      Json?
  splitMessages   Boolean?         @default(false) @db.Boolean
  timePerChar     Int?             @default(50) @db.Integer
  triggerType     TriggerType?
  triggerOperator TriggerOperator?
  triggerValue    String?
  createdAt       DateTime?        @default(now()) @db.Timestamp
  updatedAt       DateTime         @updatedAt @db.Timestamp
  Instance        Instance         @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId      String
  AgnoSetting     AgnoSetting[]

  @@index([funnelId])
}

model LlmModel {
  id         String    @id @default(cuid())
  name       String    @db.VarChar(255)
  provider   String    @db.VarChar(100)
  model      String    @db.VarChar(200)
  type       String    @db.VarChar(50)
  config     Json?     @db.JsonB
  createdAt  DateTime? @default(now()) @db.Timestamp
  updatedAt  DateTime  @updatedAt @db.Timestamp

  @@unique([provider, model])
}

model AgnoSetting {
  id              String    @id @default(cuid())
  expire          Int?      @default(0) @db.Integer
  keywordFinish   String?   @db.VarChar(100)
  delayMessage    Int?      @db.Integer
  unknownMessage  String?   @db.VarChar(100)
  listeningFromMe Boolean?  @default(false) @db.Boolean
  stopBotFromMe   Boolean?  @default(false) @db.Boolean
  keepOpen        Boolean?  @default(false) @db.Boolean
  debounceTime    Int?      @db.Integer
  ignoreJids      Json?
  splitMessages   Boolean?  @default(false) @db.Boolean
  timePerChar     Int?      @default(50) @db.Integer
  createdAt       DateTime? @default(now()) @db.Timestamp
  updatedAt       DateTime  @updatedAt @db.Timestamp
  Fallback        Agno?     @relation(fields: [agnoIdFallback], references: [id])
  agnoIdFallback  String?   @db.VarChar(100)
  Instance        Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId      String    @unique
}

model IsOnWhatsapp {
  id         String   @id @default(cuid())
  remoteJid  String   @unique @db.VarChar(100)
  jidOptions String
  lid        String?  @db.VarChar(100)
  createdAt  DateTime @default(now()) @db.Timestamp
  updatedAt  DateTime @updatedAt @db.Timestamp
}

model Funnel {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  name        String   @db.VarChar(255)
  goal        String   @db.VarChar(255)
  logic       String?  @db.VarChar(500)
  followUpEnable Boolean @default(true) @db.Boolean
  stages      Json     @db.JsonB
  status      String   @default("active") @db.VarChar(20)
  createdAt   DateTime? @default(now()) @db.Timestamp
  updatedAt   DateTime  @default(now()) @updatedAt @db.Timestamp
  Instance    Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId  String
  Company     Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  companyId   String?  @db.VarChar(100)
  @@index([instanceId])
  @@index([companyId])
}
